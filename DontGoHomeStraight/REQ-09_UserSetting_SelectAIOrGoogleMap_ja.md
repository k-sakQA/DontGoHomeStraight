# 要件定義書: ユーザーによる寄り道提案方式の選択（AI / Google Maps API）

- 対象Issue: [#9 ユーザーによる設定変更（AI or GoogleMAP APIを選択）](https://github.com/k-sakQA/DontGoHomeStraight/issues/9)
- ステータス: Draft（このドキュメントに基づき詳細設計・実装・検証を進める）
- 対象プラットフォーム: iOS（本リポジトリ構成に準拠）

## 背景 / 目的
- 現状は「寄り道を提案する」単一ボタンで、Google Maps API ベースのロジックにより候補提示を行っている。
- 今後、ユーザーが「AI による提案」か「Google Maps API による提案」を明示的に選択できるようにし、利用シーンや嗜好に応じた柔軟性を提供する。

## 用語定義
- 提案方式: 寄り道先のスポットを選ぶ手段。「AI」または「Google Maps API」。
- 気分（Mood）: ActivityType（インドア/アウトドア）× VibeType（Jazzy/発見/ワクワク 等）の組み合わせ。
- 回廊幅（Corridor Width）: 出発地-目的地間のポリラインからの許容距離。

## スコープ
- UI に「AI で提案する」ボタンを追加し、既存の「寄り道を提案する」（= Google Maps API ベース）と並列提供。
- 設定でデフォルトの提案方式を選択可能にする（任意: 仕様としては含むが、実装は段階リリース可）。
- 方式ごとの入力条件、フィルタ、スコアリング、除外リストの共通化と差分を整理。

## 前提条件 / 依存
- 位置情報・目的地情報・移動手段（徒歩/自転車/車/公共交通）・現在時刻・気分の入力が得られること。
- Google Places API / Distance Matrix API の利用に必要な API キーが設定済みであること（`API_KEYS_SETUP.md` 参照）。
- AI 方式は既存実装を利用（モデル・プロンプト・API キー設定は現行踏襲）。

## 機能要件（FR）
### FR-1: UI
- 既存の「寄り道を提案する」ボタン（Google Maps API 方式）に加えて、「AI で提案する」ボタンを追加する。
- 2 ボタンの配置は同一画面（既存提案ボタンのある画面）に縦もしくは横で並列表示。小画面では縦積み優先。
- VoiceOver/アクセシビリティラベルを適切に付与（例: "AI で提案する" / "Google マップで提案する"）。

### FR-2: デフォルト方式の設定（任意）
- 設定画面に「デフォルトの提案方式」を追加し、[AI / Google Maps API] から選択可能にする。
- デフォルト設定がある場合、メインの提案ボタン押下でデフォルト方式を実行。個別ボタンも引き続き表示。
- 設定値は端末ローカル（UserDefaults 等）に永続化。

### FR-3: Google Maps API による提案（既存）
- フィルタ（ポリライン距離/回廊幅）
  - 徒歩: 800m、自転車: 1,200m、車: 2,000m、公共交通: 1,500m 以内。
  - 出発地-目的地線分からの最短距離で事前フィルタリング。
- スコアリング（重み付け）
  - 所要時間: 負の重み 1.0（短いほど高スコア）。
  - 評価値: 重み 0.5。
  - 営業中ボーナス: 重み 2.0（現在時刻に営業中なら加点）。
  - 多様性ペナルティ: 重み 0.5（同種ばかりを抑制）。
- 気分の活用
  - ActivityType × VibeType 組み合わせに応じて Places の検索タイプを切替。
  - 例: アウトドア × 発見 → tourist_attraction / park / historical_site 等。
- 移動手段の考慮
  - Distance Matrix API で実所要時間を算出。
  - 30 分以内（段階的に最大 60 分まで緩和）を上限。
  - 回廊幅/最大半径は移動手段別に設定。

### FR-4: AI による提案（既存実装の呼び出し）
- 入力条件
  - 地理的条件: 現在地と目的地。
  - 時間的条件: 現在時刻（営業状態考慮）。
  - 気分: ActivityType × VibeType。
  - 移動手段。
  - 除外リスト: 過去に提示したスポットを除外。
- ランダム性の確保
  - 同一条件でも完全固定にならないよう、AI プロンプト/シード/候補シャッフルで揺らぎを持たせる。
- フォールバック
  - AI 側で候補ゼロ/エラー時は、Google Maps API 方式へフォールバック（ユーザーに明示的に通知）。

### FR-5: 除外リスト
- 仕様
  - 「過去に提案したスポットを再提案しない」仕組みを方式共通で適用。
- 保存先
  - 端末ローカル（UserDefaults / CoreData 等）に保存。アプリ再起動後も維持。
- 管理
  - 保存個数は直近 N 件（例: 100）または保存期間（例: 30 日）でローテーション。
  - 重複は Place ID / 一意キーで判定。

### FR-6: エラー・案内
- 位置情報未許可、API キー未設定、ネットワーク不通等の典型的エラーをユーザーに簡潔に案内。
- 方式片側が失敗した場合は、もう一方の方式を案内（ワンタップ切替を提案）。

### FR-7: ロギング / 計測（任意だが推奨）
- イベント
  - どの方式を選択したか（AI / Google）。
  - 候補提示までのレイテンシ（方式別）。
  - 表示件数、タップ/採択率、フォールバック発生率、エラー種別。
- 目的
  - 方式別の実効性や満足度を把握し今後の最適化に活用。

## 非機能要件（NFR）
- レイテンシ: ファースト候補提示まで 3 秒以内を目標（上限 7 秒）。
- 可用性: API 側障害時のフォールバックで候補提示率を確保。
- コスト/クオータ: Google / AI 双方の API コール数を制御（キャッシュ・サンプリング・バッチ化）。
- セキュリティ: API キーは `Config.plist` 等のセキュアな経路で提供（`API_KEYS_SETUP.md` 準拠）。
- プライバシー: 位置情報の取り扱いは最小限。分析用途は匿名化・集計レベルで実施。

## 画面仕様（テキスト）
- メイン画面
  - ボタンA: 「寄り道を提案する」（Google Maps API 方式）
  - ボタンB: 「AI で提案する」
  - 両ボタンの下に方式説明の短文を表示（任意）。
- 設定画面（任意）
  - 「デフォルトの提案方式」: セグメント/ラジオ [AI / Google]

## 方式ごとの詳細
### Google Maps API 方式
- フロー
  1) 現在地・目的地・移動手段・気分を取得
  2) 回廊幅で前処理フィルタ
  3) 気分に応じた Types で Places 検索
  4) Distance Matrix API で所要時間算出
  5) スコアリングして上位 N 件を提示

### AI 方式
- フロー
  1) 同上の入力をプロンプトへ整形
  2) 営業状態/移動制約/多様性を満たす候補を生成
  3) 除外リスト適用と軽いシャッフル
  4) 上位 N 件を提示

## 受け入れ条件（AC）
- AC-1: 2 つのボタンが表示され、各ボタンから対応する方式が実行される。
- AC-2: どちらの方式でも 30 分以内（緩和最大 60 分）に到達可能な候補のみが提示される。
- AC-3: 営業中ボーナスが Google 方式のスコアに反映される。
- AC-4: 除外リストに登録されている候補は再提示されない。
- AC-5: 方式のいずれかが失敗した場合、もう一方の方式への案内が表示される。
- AC-6: 主要エラー（位置情報未許可/キー未設定/ネットワーク不通）がユーザーに明確に伝達される。

## リスク / 制約
- API クォータ超過時の劣化（fallback・キャッシュ）
- 場所の一時休業/営業時間の誤差
- AI 応答のばらつき（プロンプト調整・温度制御・後段フィルタで対応）

## リリース計画（提案）
- Phase 1: UI 追加 + 方式切替の土台。AI は既存実装を直接呼び出し、ログ計測を開始。
- Phase 2: デフォルト方式設定の導入、フォールバックとエラー案内の改善。
- Phase 3: 多様性制御や回廊幅/半径の動的最適化、A/B を活用。

## 変更影響
- Presentation 層: 画面（ボタン追加、状態管理）
- Domain 層: 方式選択のユースケース、除外リスト管理
- Infrastructure 層: Places / Distance Matrix / AI クライアントの呼び分け、フォールバック制御

## 参考
- 現在の API キー設定手順: `API_KEYS_SETUP.md`
- Issue: [#9](https://github.com/k-sakQA/DontGoHomeStraight/issues/9)